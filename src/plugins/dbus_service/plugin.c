/* plugin.c generated by valac 0.16.1, the Vala compiler
 * generated from plugin.vala, do not modify */

/*
 * Copyright (C) 2009-2012 Michael 'Mickey' Lauer <mlauer@vanille-media.de>
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.

 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.

 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301  USA
 *
 */

#include <glib.h>
#include <glib-object.h>
#include <stdlib.h>
#include <string.h>
#include <fsobasics.h>
#include <fsoresource.h>
#include <fsoframework.h>
#include <fsogsm.h>
#include <gio/gio.h>


#define FSO_GSM_TYPE_SERVICE_MANAGER (fso_gsm_service_manager_get_type ())
#define FSO_GSM_SERVICE_MANAGER(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), FSO_GSM_TYPE_SERVICE_MANAGER, FsoGsmServiceManager))
#define FSO_GSM_SERVICE_MANAGER_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), FSO_GSM_TYPE_SERVICE_MANAGER, FsoGsmServiceManagerClass))
#define FSO_GSM_IS_SERVICE_MANAGER(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), FSO_GSM_TYPE_SERVICE_MANAGER))
#define FSO_GSM_IS_SERVICE_MANAGER_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), FSO_GSM_TYPE_SERVICE_MANAGER))
#define FSO_GSM_SERVICE_MANAGER_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), FSO_GSM_TYPE_SERVICE_MANAGER, FsoGsmServiceManagerClass))

typedef struct _FsoGsmServiceManager FsoGsmServiceManager;
typedef struct _FsoGsmServiceManagerClass FsoGsmServiceManagerClass;

#define FSO_GSM_TYPE_DEVICE_SERVICE_MANAGER (fso_gsm_device_service_manager_get_type ())
#define FSO_GSM_DEVICE_SERVICE_MANAGER(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), FSO_GSM_TYPE_DEVICE_SERVICE_MANAGER, FsoGsmDeviceServiceManager))
#define FSO_GSM_DEVICE_SERVICE_MANAGER_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), FSO_GSM_TYPE_DEVICE_SERVICE_MANAGER, FsoGsmDeviceServiceManagerClass))
#define FSO_GSM_IS_DEVICE_SERVICE_MANAGER(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), FSO_GSM_TYPE_DEVICE_SERVICE_MANAGER))
#define FSO_GSM_IS_DEVICE_SERVICE_MANAGER_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), FSO_GSM_TYPE_DEVICE_SERVICE_MANAGER))
#define FSO_GSM_DEVICE_SERVICE_MANAGER_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), FSO_GSM_TYPE_DEVICE_SERVICE_MANAGER, FsoGsmDeviceServiceManagerClass))

typedef struct _FsoGsmDeviceServiceManager FsoGsmDeviceServiceManager;
typedef struct _FsoGsmDeviceServiceManagerClass FsoGsmDeviceServiceManagerClass;

#define DBUS_SERVICE_TYPE_RESOURCE (dbus_service_resource_get_type ())
#define DBUS_SERVICE_RESOURCE(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), DBUS_SERVICE_TYPE_RESOURCE, DBusServiceResource))
#define DBUS_SERVICE_RESOURCE_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), DBUS_SERVICE_TYPE_RESOURCE, DBusServiceResourceClass))
#define DBUS_SERVICE_IS_RESOURCE(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), DBUS_SERVICE_TYPE_RESOURCE))
#define DBUS_SERVICE_IS_RESOURCE_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), DBUS_SERVICE_TYPE_RESOURCE))
#define DBUS_SERVICE_RESOURCE_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), DBUS_SERVICE_TYPE_RESOURCE, DBusServiceResourceClass))

typedef struct _DBusServiceResource DBusServiceResource;
typedef struct _DBusServiceResourceClass DBusServiceResourceClass;
#define _g_object_unref0(var) ((var == NULL) ? NULL : (var = (g_object_unref (var), NULL)))
#define _g_free0(var) (var = (g_free (var), NULL))
typedef struct _AsyncHelperData AsyncHelperData;

struct _AsyncHelperData {
	int _state_;
	GObject* _source_object_;
	GAsyncResult* _res_;
	GSimpleAsyncResult* _async_result;
};


extern FsoGsmDeviceServiceManager* dbus_service_deviceServiceManager;
FsoGsmDeviceServiceManager* dbus_service_deviceServiceManager = NULL;
extern DBusServiceResource* dbus_service_resource;
DBusServiceResource* dbus_service_resource = NULL;
extern gboolean running;
gboolean running = FALSE;

#define DBUS_SERVICE_MODULE_NAME "fsogsm.dbus_service"
GType fso_gsm_service_manager_get_type (void) G_GNUC_CONST;
GType fso_gsm_service_manager_register_type (GTypeModule * module);
GType fso_gsm_device_service_manager_get_type (void) G_GNUC_CONST;
GType fso_gsm_device_service_manager_register_type (GTypeModule * module);
GType dbus_service_resource_get_type (void) G_GNUC_CONST;
GType dbus_service_resource_register_type (GTypeModule * module);
gchar* fso_factory_function (FsoFrameworkSubsystem* subsystem, GError** error);
gboolean fso_gsm_modem_factory_validateModemType (const gchar* modemtype);
FsoGsmModem* fso_gsm_modem_factory_createFromTypeName (const gchar* modemtype);
FsoGsmDeviceServiceManager* fso_gsm_device_service_manager_new (FsoGsmModem* modem, FsoFrameworkSubsystem* subsystem);
FsoGsmDeviceServiceManager* fso_gsm_device_service_manager_construct (GType object_type, FsoGsmModem* modem, FsoFrameworkSubsystem* subsystem);
gboolean fso_gsm_device_service_manager_get_initialized (FsoGsmDeviceServiceManager* self);
DBusServiceResource* dbus_service_resource_new (FsoFrameworkSubsystem* subsystem, FsoGsmServiceManager* serviceManager);
DBusServiceResource* dbus_service_resource_construct (GType object_type, FsoFrameworkSubsystem* subsystem, FsoGsmServiceManager* serviceManager);
void fso_shutdown_function (GError** error);
void async_helper (GAsyncReadyCallback _callback_, gpointer _user_data_);
void async_helper_finish (GAsyncResult* _res_);
static void async_helper_data_free (gpointer _data);
static gboolean async_helper_co (AsyncHelperData* _data_);
void fso_register_function (GTypeModule* module);


/**
 * This function gets called on plugin initialization time.
 * @return the name of your plugin here
 * @note that it needs to be a name in the format <subsystem>.<plugin>
 * else your module will be unloaded immediately.
 **/
static const gchar* string_to_string (const gchar* self) {
	const gchar* result = NULL;
	g_return_val_if_fail (self != NULL, NULL);
	result = self;
	return result;
}


gchar* fso_factory_function (FsoFrameworkSubsystem* subsystem, GError** error) {
	gchar* result = NULL;
	FsoFrameworkSmartKeyFile* _tmp0_;
	gchar* _tmp1_ = NULL;
	gchar* modemtype;
	const gchar* _tmp2_;
	gboolean _tmp3_ = FALSE;
	gchar* _tmp20_;
	g_return_val_if_fail (subsystem != NULL, NULL);
	_tmp0_ = fso_framework_theConfig;
	_tmp1_ = fso_framework_smart_key_file_stringValue (_tmp0_, "fsogsm", "modem_type", "none");
	modemtype = _tmp1_;
	_tmp2_ = modemtype;
	_tmp3_ = fso_gsm_modem_factory_validateModemType (_tmp2_);
	if (_tmp3_) {
		const gchar* _tmp4_;
		FsoGsmModem* _tmp5_ = NULL;
		FsoGsmModem* modem;
		FsoGsmModem* _tmp6_;
		FsoFrameworkSubsystem* _tmp7_;
		FsoGsmDeviceServiceManager* _tmp8_;
		FsoGsmDeviceServiceManager* _tmp9_;
		gboolean _tmp10_;
		gboolean _tmp11_;
		_tmp4_ = modemtype;
		_tmp5_ = fso_gsm_modem_factory_createFromTypeName (_tmp4_);
		modem = _tmp5_;
		_tmp6_ = modem;
		_tmp7_ = subsystem;
		_tmp8_ = fso_gsm_device_service_manager_new (_tmp6_, _tmp7_);
		_g_object_unref0 (dbus_service_deviceServiceManager);
		dbus_service_deviceServiceManager = _tmp8_;
		_tmp9_ = dbus_service_deviceServiceManager;
		_tmp10_ = fso_gsm_device_service_manager_get_initialized (_tmp9_);
		_tmp11_ = _tmp10_;
		if (_tmp11_) {
			FsoFrameworkSubsystem* _tmp12_;
			FsoGsmDeviceServiceManager* _tmp13_;
			DBusServiceResource* _tmp14_;
			_tmp12_ = subsystem;
			_tmp13_ = dbus_service_deviceServiceManager;
			_tmp14_ = dbus_service_resource_new (_tmp12_, (FsoGsmServiceManager*) _tmp13_);
			_g_object_unref0 (dbus_service_resource);
			dbus_service_resource = _tmp14_;
		}
		_g_object_unref0 (modem);
	} else {
		FsoFrameworkLogger* _tmp15_;
		const gchar* _tmp16_;
		const gchar* _tmp17_ = NULL;
		gchar* _tmp18_ = NULL;
		gchar* _tmp19_;
		_tmp15_ = fso_framework_theLogger;
		_tmp16_ = modemtype;
		_tmp17_ = string_to_string (_tmp16_);
		_tmp18_ = g_strconcat ("Can't find modem for modem_type ", _tmp17_, "; corresponding modem plugin loaded?", NULL);
		_tmp19_ = _tmp18_;
		fso_framework_logger_error (_tmp15_, _tmp19_);
		_g_free0 (_tmp19_);
	}
	_tmp20_ = g_strdup (DBUS_SERVICE_MODULE_NAME);
	result = _tmp20_;
	_g_free0 (modemtype);
	return result;
}


/**
 * This function gets called on subsystem shutdown time.
 **/
void fso_shutdown_function (GError** error) {
	running = TRUE;
	async_helper (NULL, NULL);
	while (TRUE) {
		gboolean _tmp0_;
		GMainContext* _tmp1_ = NULL;
		_tmp0_ = running;
		if (!_tmp0_) {
			break;
		}
		_tmp1_ = g_main_context_default ();
		g_main_context_iteration (_tmp1_, TRUE);
	}
}


static void async_helper_data_free (gpointer _data) {
	AsyncHelperData* _data_;
	_data_ = _data;
	g_slice_free (AsyncHelperData, _data_);
}


void async_helper (GAsyncReadyCallback _callback_, gpointer _user_data_) {
	AsyncHelperData* _data_;
	_data_ = g_slice_new0 (AsyncHelperData);
	_data_->_async_result = g_simple_async_result_new (g_object_newv (G_TYPE_OBJECT, 0, NULL), _callback_, _user_data_, async_helper);
	g_simple_async_result_set_op_res_gpointer (_data_->_async_result, _data_, async_helper_data_free);
	async_helper_co (_data_);
}


void async_helper_finish (GAsyncResult* _res_) {
	AsyncHelperData* _data_;
	_data_ = g_simple_async_result_get_op_res_gpointer (G_SIMPLE_ASYNC_RESULT (_res_));
}


static gboolean async_helper_co (AsyncHelperData* _data_) {
	switch (_data_->_state_) {
		case 0:
		goto _state_0;
		default:
		g_assert_not_reached ();
	}
	_state_0:
	running = FALSE;
	if (_data_->_state_ == 0) {
		g_simple_async_result_complete_in_idle (_data_->_async_result);
	} else {
		g_simple_async_result_complete (_data_->_async_result);
	}
	g_object_unref (_data_->_async_result);
	return FALSE;
}


/**
 * Module init function, DON'T REMOVE THIS!
 **/
void fso_register_function (GTypeModule* module) {
	FsoFrameworkLogger* _tmp0_;
	g_return_if_fail (module != NULL);
	dbus_service_resource_register_type (module);
	fso_gsm_service_register_type (module);
	fso_gsm_service_manager_register_type (module);
	fso_gsm_device_service_manager_register_type (module);
	fso_gsm_modem_factory_register_type (module);
	fso_gsm_info_service_register_type (module);
	fso_gsm_device_power_supply_service_register_type (module);
	fso_gsm_device_rtc_service_register_type (module);
	fso_gsm_gsm_debug_service_register_type (module);
	fso_gsm_gsm_device_service_register_type (module);
	fso_gsm_gsm_sim_service_register_type (module);
	fso_gsm_gsm_sms_service_register_type (module);
	fso_gsm_gsm_network_service_register_type (module);
	fso_gsm_gsm_call_service_register_type (module);
	fso_gsm_gsm_call_forwarding_service_register_type (module);
	fso_gsm_gsm_hz_service_register_type (module);
	fso_gsm_gsm_cb_service_register_type (module);
	fso_gsm_gsm_voice_mail_service_register_type (module);
	fso_gsm_gsm_monitor_service_register_type (module);
	fso_gsm_gsm_pdp_service_register_type (module);
	_tmp0_ = fso_framework_theLogger;
	fso_framework_logger_debug (_tmp0_, "fsogsm.dbus_service fso_register_function");
}



