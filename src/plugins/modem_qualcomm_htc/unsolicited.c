/* unsolicited.c generated by valac 0.16.0, the Vala compiler
 * generated from unsolicited.vala, do not modify */


#include <glib.h>
#include <glib-object.h>
#include <fsogsm.h>
#include <stdlib.h>
#include <string.h>
#include <fsobasics.h>
#include <time.h>


#define QUALCOMM_HTC_TYPE_UNSOLICITED_RESPONSE_HANDLER (qualcomm_htc_unsolicited_response_handler_get_type ())
#define QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), QUALCOMM_HTC_TYPE_UNSOLICITED_RESPONSE_HANDLER, QualcommHtcUnsolicitedResponseHandler))
#define QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), QUALCOMM_HTC_TYPE_UNSOLICITED_RESPONSE_HANDLER, QualcommHtcUnsolicitedResponseHandlerClass))
#define QUALCOMM_HTC_IS_UNSOLICITED_RESPONSE_HANDLER(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), QUALCOMM_HTC_TYPE_UNSOLICITED_RESPONSE_HANDLER))
#define QUALCOMM_HTC_IS_UNSOLICITED_RESPONSE_HANDLER_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), QUALCOMM_HTC_TYPE_UNSOLICITED_RESPONSE_HANDLER))
#define QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), QUALCOMM_HTC_TYPE_UNSOLICITED_RESPONSE_HANDLER, QualcommHtcUnsolicitedResponseHandlerClass))

typedef struct _QualcommHtcUnsolicitedResponseHandler QualcommHtcUnsolicitedResponseHandler;
typedef struct _QualcommHtcUnsolicitedResponseHandlerClass QualcommHtcUnsolicitedResponseHandlerClass;
typedef struct _QualcommHtcUnsolicitedResponseHandlerPrivate QualcommHtcUnsolicitedResponseHandlerPrivate;

#define QUALCOMM_HTC_TYPE_PLUS_HTCCTZV (qualcomm_htc_plus_htcctzv_get_type ())
#define QUALCOMM_HTC_PLUS_HTCCTZV(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), QUALCOMM_HTC_TYPE_PLUS_HTCCTZV, QualcommHtcPlusHTCCTZV))
#define QUALCOMM_HTC_PLUS_HTCCTZV_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), QUALCOMM_HTC_TYPE_PLUS_HTCCTZV, QualcommHtcPlusHTCCTZVClass))
#define QUALCOMM_HTC_IS_PLUS_HTCCTZV(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), QUALCOMM_HTC_TYPE_PLUS_HTCCTZV))
#define QUALCOMM_HTC_IS_PLUS_HTCCTZV_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), QUALCOMM_HTC_TYPE_PLUS_HTCCTZV))
#define QUALCOMM_HTC_PLUS_HTCCTZV_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), QUALCOMM_HTC_TYPE_PLUS_HTCCTZV, QualcommHtcPlusHTCCTZVClass))

typedef struct _QualcommHtcPlusHTCCTZV QualcommHtcPlusHTCCTZV;
typedef struct _QualcommHtcPlusHTCCTZVClass QualcommHtcPlusHTCCTZVClass;
#define _g_free0(var) (var = (g_free (var), NULL))
typedef struct _QualcommHtcPlusHTCCTZVPrivate QualcommHtcPlusHTCCTZVPrivate;
#define _g_object_unref0(var) ((var == NULL) ? NULL : (var = (g_object_unref (var), NULL)))

struct _QualcommHtcUnsolicitedResponseHandler {
	FsoGsmAtUnsolicitedResponseHandler parent_instance;
	QualcommHtcUnsolicitedResponseHandlerPrivate * priv;
};

struct _QualcommHtcUnsolicitedResponseHandlerClass {
	FsoGsmAtUnsolicitedResponseHandlerClass parent_class;
	void (*plusPB_READY) (QualcommHtcUnsolicitedResponseHandler* self, const gchar* prefix, const gchar* rhs);
	void (*plusHTCCTZV) (QualcommHtcUnsolicitedResponseHandler* self, const gchar* prefix, const gchar* rhs);
};

struct _QualcommHtcUnsolicitedResponseHandlerPrivate {
	gboolean phbReady;
	gboolean fullReady;
};

struct _QualcommHtcPlusHTCCTZV {
	FsoGsmAbstractAtCommand parent_instance;
	QualcommHtcPlusHTCCTZVPrivate * priv;
	gint year;
	gint month;
	gint day;
	gint hour;
	gint minute;
	gint second;
	gint tzoffset;
};

struct _QualcommHtcPlusHTCCTZVClass {
	FsoGsmAbstractAtCommandClass parent_class;
};


static gpointer qualcomm_htc_unsolicited_response_handler_parent_class = NULL;
static GType qualcomm_htc_unsolicited_response_handler_type_id = 0;

GType qualcomm_htc_unsolicited_response_handler_get_type (void) G_GNUC_CONST;
GType qualcomm_htc_unsolicited_response_handler_register_type (GTypeModule * module);
#define QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER_GET_PRIVATE(o) (G_TYPE_INSTANCE_GET_PRIVATE ((o), QUALCOMM_HTC_TYPE_UNSOLICITED_RESPONSE_HANDLER, QualcommHtcUnsolicitedResponseHandlerPrivate))
enum  {
	QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER_DUMMY_PROPERTY
};
static void qualcomm_htc_unsolicited_response_handler_updateReadyness (QualcommHtcUnsolicitedResponseHandler* self);
QualcommHtcUnsolicitedResponseHandler* qualcomm_htc_unsolicited_response_handler_new (FsoGsmModem* modem);
QualcommHtcUnsolicitedResponseHandler* qualcomm_htc_unsolicited_response_handler_construct (GType object_type, FsoGsmModem* modem);
void qualcomm_htc_unsolicited_response_handler_plusPB_READY (QualcommHtcUnsolicitedResponseHandler* self, const gchar* prefix, const gchar* rhs);
static void _qualcomm_htc_unsolicited_response_handler_plusPB_READY_unsolicited_response_handler_func (const gchar* prefix, const gchar* rhs, gpointer self);
void qualcomm_htc_unsolicited_response_handler_plusHTCCTZV (QualcommHtcUnsolicitedResponseHandler* self, const gchar* prefix, const gchar* rhs);
static void _qualcomm_htc_unsolicited_response_handler_plusHTCCTZV_unsolicited_response_handler_func (const gchar* prefix, const gchar* rhs, gpointer self);
static void qualcomm_htc_unsolicited_response_handler_real_plusPB_READY (QualcommHtcUnsolicitedResponseHandler* self, const gchar* prefix, const gchar* rhs);
static void qualcomm_htc_unsolicited_response_handler_real_plusHTCCTZV (QualcommHtcUnsolicitedResponseHandler* self, const gchar* prefix, const gchar* rhs);
GType qualcomm_htc_plus_htcctzv_get_type (void) G_GNUC_CONST;
GType qualcomm_htc_plus_htcctzv_register_type (GTypeModule * module);
static void qualcomm_htc_unsolicited_response_handler_finalize (GObject* obj);


static void qualcomm_htc_unsolicited_response_handler_updateReadyness (QualcommHtcUnsolicitedResponseHandler* self) {
	gboolean _tmp0_;
	gboolean newFullReady;
	gboolean _tmp1_;
	gboolean _tmp2_;
	g_return_if_fail (self != NULL);
	_tmp0_ = self->priv->phbReady;
	newFullReady = _tmp0_;
	_tmp1_ = newFullReady;
	_tmp2_ = self->priv->fullReady;
	if (_tmp1_ != _tmp2_) {
		gboolean _tmp3_;
		gboolean _tmp4_;
		_tmp3_ = newFullReady;
		self->priv->fullReady = _tmp3_;
		_tmp4_ = self->priv->fullReady;
		if (_tmp4_) {
			FsoGsmModem* _tmp5_;
			FsoGsmModem* _tmp6_;
			FsoFrameworkLogger* _tmp7_;
			FsoGsmModem* _tmp8_;
			FsoGsmModem* _tmp9_;
			_tmp5_ = fso_gsm_base_unsolicited_response_handler_get_modem ((FsoGsmBaseUnsolicitedResponseHandler*) self);
			_tmp6_ = _tmp5_;
			_tmp7_ = ((FsoFrameworkAbstractObject*) _tmp6_)->logger;
			fso_framework_logger_info (_tmp7_, "qualcomm_htc sim ready");
			_tmp8_ = fso_gsm_base_unsolicited_response_handler_get_modem ((FsoGsmBaseUnsolicitedResponseHandler*) self);
			_tmp9_ = _tmp8_;
			fso_gsm_modem_advanceToState (_tmp9_, FSO_GSM_MODEM_STATUS_ALIVE_SIM_READY, FALSE);
		}
	}
}


static void _qualcomm_htc_unsolicited_response_handler_plusPB_READY_unsolicited_response_handler_func (const gchar* prefix, const gchar* rhs, gpointer self) {
	qualcomm_htc_unsolicited_response_handler_plusPB_READY (self, prefix, rhs);
}


static void _qualcomm_htc_unsolicited_response_handler_plusHTCCTZV_unsolicited_response_handler_func (const gchar* prefix, const gchar* rhs, gpointer self) {
	qualcomm_htc_unsolicited_response_handler_plusHTCCTZV (self, prefix, rhs);
}


QualcommHtcUnsolicitedResponseHandler* qualcomm_htc_unsolicited_response_handler_construct (GType object_type, FsoGsmModem* modem) {
	QualcommHtcUnsolicitedResponseHandler * self = NULL;
	FsoGsmModem* _tmp0_;
	g_return_val_if_fail (modem != NULL, NULL);
	_tmp0_ = modem;
	self = (QualcommHtcUnsolicitedResponseHandler*) fso_gsm_at_unsolicited_response_handler_construct (object_type, _tmp0_);
	fso_gsm_base_unsolicited_response_handler_registerUrc ((FsoGsmBaseUnsolicitedResponseHandler*) self, "+PB_READY", _qualcomm_htc_unsolicited_response_handler_plusPB_READY_unsolicited_response_handler_func, self);
	fso_gsm_base_unsolicited_response_handler_registerUrc ((FsoGsmBaseUnsolicitedResponseHandler*) self, "+HTCCTZV", _qualcomm_htc_unsolicited_response_handler_plusHTCCTZV_unsolicited_response_handler_func, self);
	return self;
}


QualcommHtcUnsolicitedResponseHandler* qualcomm_htc_unsolicited_response_handler_new (FsoGsmModem* modem) {
	return qualcomm_htc_unsolicited_response_handler_construct (QUALCOMM_HTC_TYPE_UNSOLICITED_RESPONSE_HANDLER, modem);
}


/**
     * Qualcomm HTC subsystem status report:
     *
     * +PB_READY
     *
     * Sent, after the reading the SIM phonebook into internal RAM
     **/
static void qualcomm_htc_unsolicited_response_handler_real_plusPB_READY (QualcommHtcUnsolicitedResponseHandler* self, const gchar* prefix, const gchar* rhs) {
	g_return_if_fail (prefix != NULL);
	g_return_if_fail (rhs != NULL);
	self->priv->phbReady = TRUE;
	qualcomm_htc_unsolicited_response_handler_updateReadyness (self);
}


void qualcomm_htc_unsolicited_response_handler_plusPB_READY (QualcommHtcUnsolicitedResponseHandler* self, const gchar* prefix, const gchar* rhs) {
	g_return_if_fail (self != NULL);
	QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER_GET_CLASS (self)->plusPB_READY (self, prefix, rhs);
}


/**
     * Qualcomm HTC time report
     *
     * +HTCCTZV: "10/05/02,15:27:30+08,1"
     *
     */
static const gchar* string_to_string (const gchar* self) {
	const gchar* result = NULL;
	g_return_val_if_fail (self != NULL, NULL);
	result = self;
	return result;
}


static void qualcomm_htc_unsolicited_response_handler_real_plusHTCCTZV (QualcommHtcUnsolicitedResponseHandler* self, const gchar* prefix, const gchar* rhs) {
	FsoGsmModem* _tmp0_;
	FsoGsmModem* _tmp1_;
	gpointer _tmp2_ = NULL;
	QualcommHtcPlusHTCCTZV* htcctv;
	QualcommHtcPlusHTCCTZV* _tmp3_;
	const gchar* _tmp4_;
	const gchar* _tmp5_ = NULL;
	const gchar* _tmp6_;
	const gchar* _tmp7_ = NULL;
	gchar* _tmp8_ = NULL;
	gchar* _tmp9_;
	FsoGsmConstantsAtResponse _tmp10_ = 0;
	gboolean _tmp11_;
	g_return_if_fail (prefix != NULL);
	g_return_if_fail (rhs != NULL);
	_tmp0_ = fso_gsm_base_unsolicited_response_handler_get_modem ((FsoGsmBaseUnsolicitedResponseHandler*) self);
	_tmp1_ = _tmp0_;
	_tmp2_ = fso_gsm_modem_createAtCommand (_tmp1_, QUALCOMM_HTC_TYPE_PLUS_HTCCTZV, (GBoxedCopyFunc) g_object_ref, g_object_unref, "+HTCCTZV");
	htcctv = (QualcommHtcPlusHTCCTZV*) _tmp2_;
	_tmp3_ = htcctv;
	_tmp4_ = prefix;
	_tmp5_ = string_to_string (_tmp4_);
	_tmp6_ = rhs;
	_tmp7_ = string_to_string (_tmp6_);
	_tmp8_ = g_strconcat (_tmp5_, ": ", _tmp7_, NULL);
	_tmp9_ = _tmp8_;
	_tmp10_ = fso_gsm_abstract_at_command_validateUrc ((FsoGsmAbstractAtCommand*) _tmp3_, _tmp9_);
	_tmp11_ = _tmp10_ == FSO_GSM_CONSTANTS_AT_RESPONSE_VALID;
	_g_free0 (_tmp9_);
	if (_tmp11_) {
		struct tm _tmp12_ = {0};
		struct tm t;
		QualcommHtcPlusHTCCTZV* _tmp13_;
		gint _tmp14_;
		QualcommHtcPlusHTCCTZV* _tmp15_;
		gint _tmp16_;
		QualcommHtcPlusHTCCTZV* _tmp17_;
		gint _tmp18_;
		QualcommHtcPlusHTCCTZV* _tmp19_;
		gint _tmp20_;
		QualcommHtcPlusHTCCTZV* _tmp21_;
		gint _tmp22_;
		QualcommHtcPlusHTCCTZV* _tmp23_;
		gint _tmp24_;
		struct tm _tmp25_;
		time_t _tmp26_ = 0;
		time_t epoch;
		FsoGsmModem* _tmp27_;
		FsoGsmModem* _tmp28_;
		FsoGsmModemData* _tmp29_ = NULL;
		FsoGsmModemData* data;
		FsoGsmModemData* _tmp30_;
		FsoGsmNetworkTimeReport* _tmp31_;
		time_t _tmp32_;
		QualcommHtcPlusHTCCTZV* _tmp33_;
		gint _tmp34_;
		t = _tmp12_;
		_tmp13_ = htcctv;
		_tmp14_ = _tmp13_->hour;
		t.tm_hour = _tmp14_;
		_tmp15_ = htcctv;
		_tmp16_ = _tmp15_->minute;
		t.tm_min = _tmp16_;
		_tmp17_ = htcctv;
		_tmp18_ = _tmp17_->second;
		t.tm_sec = _tmp18_;
		_tmp19_ = htcctv;
		_tmp20_ = _tmp19_->day;
		t.tm_mday = _tmp20_;
		_tmp21_ = htcctv;
		_tmp22_ = _tmp21_->month;
		t.tm_mon = _tmp22_ - 1;
		_tmp23_ = htcctv;
		_tmp24_ = _tmp23_->year;
		t.tm_year = _tmp24_ - 1900;
		_tmp25_ = t;
		_tmp26_ = timegm (&_tmp25_);
		epoch = _tmp26_;
		_tmp27_ = fso_gsm_base_unsolicited_response_handler_get_modem ((FsoGsmBaseUnsolicitedResponseHandler*) self);
		_tmp28_ = _tmp27_;
		_tmp29_ = fso_gsm_modem_data (_tmp28_);
		data = _tmp29_;
		_tmp30_ = data;
		_tmp31_ = _tmp30_->networkTimeReport;
		_tmp32_ = epoch;
		_tmp33_ = htcctv;
		_tmp34_ = _tmp33_->tzoffset;
		fso_gsm_network_time_report_setTimeAndZone (_tmp31_, (gint) _tmp32_, _tmp34_);
		_g_object_unref0 (data);
	} else {
		FsoFrameworkLogger* _tmp35_;
		const gchar* _tmp36_;
		const gchar* _tmp37_ = NULL;
		gchar* _tmp38_ = NULL;
		gchar* _tmp39_;
		_tmp35_ = ((FsoFrameworkAbstractObject*) self)->logger;
		_tmp36_ = rhs;
		_tmp37_ = string_to_string (_tmp36_);
		_tmp38_ = g_strconcat ("Received invalid +HTCCTZV message ", _tmp37_, ". Please report", NULL);
		_tmp39_ = _tmp38_;
		fso_framework_logger_warning (_tmp35_, _tmp39_);
		_g_free0 (_tmp39_);
	}
	_g_object_unref0 (htcctv);
}


void qualcomm_htc_unsolicited_response_handler_plusHTCCTZV (QualcommHtcUnsolicitedResponseHandler* self, const gchar* prefix, const gchar* rhs) {
	g_return_if_fail (self != NULL);
	QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER_GET_CLASS (self)->plusHTCCTZV (self, prefix, rhs);
}


static void qualcomm_htc_unsolicited_response_handler_class_init (QualcommHtcUnsolicitedResponseHandlerClass * klass) {
	qualcomm_htc_unsolicited_response_handler_parent_class = g_type_class_peek_parent (klass);
	g_type_class_add_private (klass, sizeof (QualcommHtcUnsolicitedResponseHandlerPrivate));
	QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER_CLASS (klass)->plusPB_READY = qualcomm_htc_unsolicited_response_handler_real_plusPB_READY;
	QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER_CLASS (klass)->plusHTCCTZV = qualcomm_htc_unsolicited_response_handler_real_plusHTCCTZV;
	G_OBJECT_CLASS (klass)->finalize = qualcomm_htc_unsolicited_response_handler_finalize;
}


static void qualcomm_htc_unsolicited_response_handler_instance_init (QualcommHtcUnsolicitedResponseHandler * self) {
	self->priv = QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER_GET_PRIVATE (self);
}


static void qualcomm_htc_unsolicited_response_handler_finalize (GObject* obj) {
	QualcommHtcUnsolicitedResponseHandler * self;
	self = QUALCOMM_HTC_UNSOLICITED_RESPONSE_HANDLER (obj);
	G_OBJECT_CLASS (qualcomm_htc_unsolicited_response_handler_parent_class)->finalize (obj);
}


/**
 * Copyright (C) 2009-2012 Michael 'Mickey' Lauer <mlauer@vanille-media.de>
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.

 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.

 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301  USA
 *
 */
GType qualcomm_htc_unsolicited_response_handler_get_type (void) {
	return qualcomm_htc_unsolicited_response_handler_type_id;
}


GType qualcomm_htc_unsolicited_response_handler_register_type (GTypeModule * module) {
	static const GTypeInfo g_define_type_info = { sizeof (QualcommHtcUnsolicitedResponseHandlerClass), (GBaseInitFunc) NULL, (GBaseFinalizeFunc) NULL, (GClassInitFunc) qualcomm_htc_unsolicited_response_handler_class_init, (GClassFinalizeFunc) NULL, NULL, sizeof (QualcommHtcUnsolicitedResponseHandler), 0, (GInstanceInitFunc) qualcomm_htc_unsolicited_response_handler_instance_init, NULL };
	qualcomm_htc_unsolicited_response_handler_type_id = g_type_module_register_type (module, FSO_GSM_TYPE_AT_UNSOLICITED_RESPONSE_HANDLER, "QualcommHtcUnsolicitedResponseHandler", &g_define_type_info, 0);
	return qualcomm_htc_unsolicited_response_handler_type_id;
}



