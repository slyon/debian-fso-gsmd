/* smshandler.c generated by valac 0.16.1, the Vala compiler
 * generated from smshandler.vala, do not modify */

/*
 * Copyright (C) 2012 Simon Busch <morphis@gravedo.de>
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.

 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.

 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301  USA
 *
 */

#include <glib.h>
#include <glib-object.h>
#include <fsogsm.h>
#include <gio/gio.h>
#include <stdlib.h>
#include <string.h>


#define GTM601_TYPE_SMS_HANDLER (gtm601_sms_handler_get_type ())
#define GTM601_SMS_HANDLER(obj) (G_TYPE_CHECK_INSTANCE_CAST ((obj), GTM601_TYPE_SMS_HANDLER, Gtm601SmsHandler))
#define GTM601_SMS_HANDLER_CLASS(klass) (G_TYPE_CHECK_CLASS_CAST ((klass), GTM601_TYPE_SMS_HANDLER, Gtm601SmsHandlerClass))
#define GTM601_IS_SMS_HANDLER(obj) (G_TYPE_CHECK_INSTANCE_TYPE ((obj), GTM601_TYPE_SMS_HANDLER))
#define GTM601_IS_SMS_HANDLER_CLASS(klass) (G_TYPE_CHECK_CLASS_TYPE ((klass), GTM601_TYPE_SMS_HANDLER))
#define GTM601_SMS_HANDLER_GET_CLASS(obj) (G_TYPE_INSTANCE_GET_CLASS ((obj), GTM601_TYPE_SMS_HANDLER, Gtm601SmsHandlerClass))

typedef struct _Gtm601SmsHandler Gtm601SmsHandler;
typedef struct _Gtm601SmsHandlerClass Gtm601SmsHandlerClass;
typedef struct _Gtm601SmsHandlerPrivate Gtm601SmsHandlerPrivate;
#define _g_object_unref0(var) ((var == NULL) ? NULL : (var = (g_object_unref (var), NULL)))
typedef struct _gtm601_sms_handler_configureMessageIndicationsData gtm601_sms_handler_configureMessageIndicationsData;

struct _Gtm601SmsHandler {
	FsoGsmAtSmsHandler parent_instance;
	Gtm601SmsHandlerPrivate * priv;
};

struct _Gtm601SmsHandlerClass {
	FsoGsmAtSmsHandlerClass parent_class;
};

struct _gtm601_sms_handler_configureMessageIndicationsData {
	int _state_;
	GObject* _source_object_;
	GAsyncResult* _res_;
	GSimpleAsyncResult* _async_result;
	Gtm601SmsHandler* self;
	gboolean result;
	FsoGsmModem* _tmp0_;
	FsoGsmModem* _tmp1_;
	gpointer _tmp2_;
	FsoGsmPlusCNMI* cnmi;
	const gchar* _tmp3_;
	FsoGsmModem* _tmp4_;
	FsoGsmModem* _tmp5_;
	FsoGsmModemData* _tmp6_;
	FsoGsmModemData* _tmp7_;
	gboolean _tmp8_;
	gboolean _tmp9_;
	FsoGsmModem* _tmp10_;
	FsoGsmModem* _tmp11_;
	FsoGsmPlusCNMI* _tmp12_;
	const gchar* _tmp13_;
	gint _tmp14_;
	gchar** _tmp15_;
	gchar** response;
	gint response_length1;
	gint _response_size_;
	FsoGsmPlusCNMI* _tmp16_;
	gchar** _tmp17_;
	gint _tmp17__length1;
	FsoGsmConstantsAtResponse _tmp18_;
};


static gpointer gtm601_sms_handler_parent_class = NULL;
static GType gtm601_sms_handler_type_id = 0;

GType gtm601_sms_handler_get_type (void) G_GNUC_CONST;
GType gtm601_sms_handler_register_type (GTypeModule * module);
enum  {
	GTM601_SMS_HANDLER_DUMMY_PROPERTY
};
Gtm601SmsHandler* gtm601_sms_handler_new (FsoGsmModem* modem);
Gtm601SmsHandler* gtm601_sms_handler_construct (GType object_type, FsoGsmModem* modem);
static void gtm601_sms_handler_real_configureMessageIndications_data_free (gpointer _data);
static void gtm601_sms_handler_real_configureMessageIndications (FsoGsmAtSmsHandler* base, GAsyncReadyCallback _callback_, gpointer _user_data_);
static gboolean gtm601_sms_handler_real_configureMessageIndications_co (gtm601_sms_handler_configureMessageIndicationsData* _data_);
static void gtm601_sms_handler_configureMessageIndications_ready (GObject* source_object, GAsyncResult* _res_, gpointer _user_data_);
static void _vala_array_destroy (gpointer array, gint array_length, GDestroyNotify destroy_func);
static void _vala_array_free (gpointer array, gint array_length, GDestroyNotify destroy_func);


Gtm601SmsHandler* gtm601_sms_handler_construct (GType object_type, FsoGsmModem* modem) {
	Gtm601SmsHandler * self = NULL;
	FsoGsmModem* _tmp0_;
	g_return_val_if_fail (modem != NULL, NULL);
	_tmp0_ = modem;
	self = (Gtm601SmsHandler*) fso_gsm_at_sms_handler_construct (object_type, _tmp0_);
	return self;
}


Gtm601SmsHandler* gtm601_sms_handler_new (FsoGsmModem* modem) {
	return gtm601_sms_handler_construct (GTM601_TYPE_SMS_HANDLER, modem);
}


static void gtm601_sms_handler_real_configureMessageIndications_data_free (gpointer _data) {
	gtm601_sms_handler_configureMessageIndicationsData* _data_;
	_data_ = _data;
	_g_object_unref0 (_data_->self);
	g_slice_free (gtm601_sms_handler_configureMessageIndicationsData, _data_);
}


static gpointer _g_object_ref0 (gpointer self) {
	return self ? g_object_ref (self) : NULL;
}


static void gtm601_sms_handler_real_configureMessageIndications (FsoGsmAtSmsHandler* base, GAsyncReadyCallback _callback_, gpointer _user_data_) {
	Gtm601SmsHandler * self;
	gtm601_sms_handler_configureMessageIndicationsData* _data_;
	Gtm601SmsHandler* _tmp0_;
	self = (Gtm601SmsHandler*) base;
	_data_ = g_slice_new0 (gtm601_sms_handler_configureMessageIndicationsData);
	_data_->_async_result = g_simple_async_result_new (G_OBJECT (self), _callback_, _user_data_, gtm601_sms_handler_real_configureMessageIndications);
	g_simple_async_result_set_op_res_gpointer (_data_->_async_result, _data_, gtm601_sms_handler_real_configureMessageIndications_data_free);
	_tmp0_ = _g_object_ref0 (self);
	_data_->self = _tmp0_;
	gtm601_sms_handler_real_configureMessageIndications_co (_data_);
}


static gboolean gtm601_sms_handler_real_configureMessageIndications_finish (FsoGsmAtSmsHandler* base, GAsyncResult* _res_) {
	gboolean result;
	gtm601_sms_handler_configureMessageIndicationsData* _data_;
	_data_ = g_simple_async_result_get_op_res_gpointer (G_SIMPLE_ASYNC_RESULT (_res_));
	result = _data_->result;
	return result;
}


static void gtm601_sms_handler_configureMessageIndications_ready (GObject* source_object, GAsyncResult* _res_, gpointer _user_data_) {
	gtm601_sms_handler_configureMessageIndicationsData* _data_;
	_data_ = _user_data_;
	_data_->_source_object_ = source_object;
	_data_->_res_ = _res_;
	gtm601_sms_handler_real_configureMessageIndications_co (_data_);
}


static gboolean gtm601_sms_handler_real_configureMessageIndications_co (gtm601_sms_handler_configureMessageIndicationsData* _data_) {
	switch (_data_->_state_) {
		case 0:
		goto _state_0;
		case 1:
		goto _state_1;
		default:
		g_assert_not_reached ();
	}
	_state_0:
	_data_->_tmp0_ = fso_gsm_abstract_sms_handler_get_modem ((FsoGsmAbstractSmsHandler*) _data_->self);
	_data_->_tmp1_ = _data_->_tmp0_;
	_data_->_tmp2_ = NULL;
	_data_->_tmp2_ = fso_gsm_modem_createAtCommand (_data_->_tmp1_, FSO_GSM_TYPE_PLUS_CNMI, (GBoxedCopyFunc) g_object_ref, g_object_unref, "+CNMI");
	_data_->cnmi = (FsoGsmPlusCNMI*) _data_->_tmp2_;
	_data_->_tmp4_ = fso_gsm_abstract_sms_handler_get_modem ((FsoGsmAbstractSmsHandler*) _data_->self);
	_data_->_tmp5_ = _data_->_tmp4_;
	_data_->_tmp6_ = NULL;
	_data_->_tmp6_ = fso_gsm_modem_data (_data_->_tmp5_);
	_data_->_tmp7_ = _data_->_tmp6_;
	_data_->_tmp8_ = _data_->_tmp7_->simBuffersSms;
	_data_->_tmp9_ = _data_->_tmp8_;
	_g_object_unref0 (_data_->_tmp7_);
	if (_data_->_tmp9_) {
		_data_->_tmp3_ = "+CNMI=2,1,2,1,1";
	} else {
		_data_->_tmp3_ = "+CNMI=2,2,2,1,1";
	}
	_data_->_tmp10_ = fso_gsm_abstract_sms_handler_get_modem ((FsoGsmAbstractSmsHandler*) _data_->self);
	_data_->_tmp11_ = _data_->_tmp10_;
	_data_->_tmp12_ = _data_->cnmi;
	_data_->_tmp13_ = _data_->_tmp3_;
	_data_->_tmp14_ = 0;
	_data_->_state_ = 1;
	fso_gsm_modem_processAtCommandAsync (_data_->_tmp11_, (FsoGsmAtCommand*) _data_->_tmp12_, _data_->_tmp13_, FSO_GSM_MODEM_DEFAULT_RETRIES, 0, gtm601_sms_handler_configureMessageIndications_ready, _data_);
	return FALSE;
	_state_1:
	_data_->_tmp15_ = NULL;
	_data_->_tmp15_ = fso_gsm_modem_processAtCommandAsync_finish (_data_->_tmp11_, _data_->_res_, &_data_->_tmp14_);
	_data_->response = _data_->_tmp15_;
	_data_->response_length1 = _data_->_tmp14_;
	_data_->_response_size_ = _data_->response_length1;
	_data_->_tmp16_ = _data_->cnmi;
	_data_->_tmp17_ = _data_->response;
	_data_->_tmp17__length1 = _data_->response_length1;
	_data_->_tmp18_ = 0;
	_data_->_tmp18_ = fso_gsm_abstract_at_command_validateOk ((FsoGsmAbstractAtCommand*) _data_->_tmp16_, _data_->_tmp17_, _data_->_tmp17__length1);
	if (_data_->_tmp18_ != FSO_GSM_CONSTANTS_AT_RESPONSE_OK) {
		_data_->result = FALSE;
		_data_->response = (_vala_array_free (_data_->response, _data_->response_length1, (GDestroyNotify) g_free), NULL);
		_g_object_unref0 (_data_->cnmi);
		if (_data_->_state_ == 0) {
			g_simple_async_result_complete_in_idle (_data_->_async_result);
		} else {
			g_simple_async_result_complete (_data_->_async_result);
		}
		g_object_unref (_data_->_async_result);
		return FALSE;
	}
	_data_->result = TRUE;
	_data_->response = (_vala_array_free (_data_->response, _data_->response_length1, (GDestroyNotify) g_free), NULL);
	_g_object_unref0 (_data_->cnmi);
	if (_data_->_state_ == 0) {
		g_simple_async_result_complete_in_idle (_data_->_async_result);
	} else {
		g_simple_async_result_complete (_data_->_async_result);
	}
	g_object_unref (_data_->_async_result);
	return FALSE;
	_data_->response = (_vala_array_free (_data_->response, _data_->response_length1, (GDestroyNotify) g_free), NULL);
	_g_object_unref0 (_data_->cnmi);
	if (_data_->_state_ == 0) {
		g_simple_async_result_complete_in_idle (_data_->_async_result);
	} else {
		g_simple_async_result_complete (_data_->_async_result);
	}
	g_object_unref (_data_->_async_result);
	return FALSE;
}


static void gtm601_sms_handler_class_init (Gtm601SmsHandlerClass * klass) {
	gtm601_sms_handler_parent_class = g_type_class_peek_parent (klass);
	FSO_GSM_AT_SMS_HANDLER_CLASS (klass)->configureMessageIndications = gtm601_sms_handler_real_configureMessageIndications;
	FSO_GSM_AT_SMS_HANDLER_CLASS (klass)->configureMessageIndications_finish = gtm601_sms_handler_real_configureMessageIndications_finish;
}


static void gtm601_sms_handler_instance_init (Gtm601SmsHandler * self) {
}


GType gtm601_sms_handler_get_type (void) {
	return gtm601_sms_handler_type_id;
}


GType gtm601_sms_handler_register_type (GTypeModule * module) {
	static const GTypeInfo g_define_type_info = { sizeof (Gtm601SmsHandlerClass), (GBaseInitFunc) NULL, (GBaseFinalizeFunc) NULL, (GClassInitFunc) gtm601_sms_handler_class_init, (GClassFinalizeFunc) NULL, NULL, sizeof (Gtm601SmsHandler), 0, (GInstanceInitFunc) gtm601_sms_handler_instance_init, NULL };
	gtm601_sms_handler_type_id = g_type_module_register_type (module, FSO_GSM_TYPE_AT_SMS_HANDLER, "Gtm601SmsHandler", &g_define_type_info, 0);
	return gtm601_sms_handler_type_id;
}


static void _vala_array_destroy (gpointer array, gint array_length, GDestroyNotify destroy_func) {
	if ((array != NULL) && (destroy_func != NULL)) {
		int i;
		for (i = 0; i < array_length; i = i + 1) {
			if (((gpointer*) array)[i] != NULL) {
				destroy_func (((gpointer*) array)[i]);
			}
		}
	}
}


static void _vala_array_free (gpointer array, gint array_length, GDestroyNotify destroy_func) {
	_vala_array_destroy (array, array_length, destroy_func);
	g_free (array);
}



